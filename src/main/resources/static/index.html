<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Course Payment</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .container {
            background: #fff;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            width: 360px;
        }
        input, button {
            margin-top: 10px;
            padding: 10px;
            width: 100%;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        button {
            background-color: #3399cc;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #2d89b8;
        }
        h2 {
            text-align: center;
        }
    </style>
</head>
<body>
<div class="container">
    <h2>Buy Course</h2>

    <label>Access Token (from login):</label>
    <input type="text" id="accessToken" placeholder="Paste your access token here" required />

    <label>Email:</label>
    <input type="email" id="email" readonly />

    <label>Name:</label>
    <input type="text" id="name" readonly />

    <label>Course ID:</label>
    <input type="number" id="courseId" value="1" required />

    <label>Amount (â‚¹):</label>
    <input type="number" id="amount" value="499" required />

    <button id="payButton">Pay Now</button>
</div>

<script>
    // ðŸ”¹ Decode JWT (Base64)
    function decodeJWT(token) {
        try {
            const payload = token.split('.')[1];
            return JSON.parse(atob(payload));
        } catch (e) {
            return null;
        }
    }

    // Auto-fill user details when token is entered
    document.getElementById('accessToken').addEventListener('input', function() {
        const token = this.value.trim();
        if (token) {
            const data = decodeJWT(token);
            if (data && data.sub) {
                document.getElementById('email').value = data.sub; // subject = email
                if (data.name) {
                    document.getElementById('name').value = data.name;
                } else if (data.role) {
                    document.getElementById('name').value = data.role;
                }
            }
        }
    });

    document.getElementById('payButton').addEventListener('click', async function(e) {
        e.preventDefault();

        const token = document.getElementById('accessToken').value.trim();
        if (!token) {
            alert("Please paste your access token first!");
            return;
        }

        const courseId = document.getElementById('courseId').value;
        const amount = document.getElementById('amount').value;

        try {
            const orderRes = await fetch("https://e-learning-platform-w2l1.onrender.com", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify({
                    courseId: courseId,
                    amount: amount
                })
            });

            if (!orderRes.ok) {
                const errText = await orderRes.text();
                throw new Error("Failed to create order: " + errText);
            }

            const orderData = await orderRes.json();


            const options = {
                "key": "${RZPAY_Id}",
                "amount": orderData.amount,
                "currency": orderData.currency,
                "name": "E-Learning Platform",
                "description": "Course Purchase",
                "order_id": orderData.id,
                "handler": async function (response) {
                    const verifyRes = await fetch("https://e-learning-platform-w2l1.onrender.com", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            razorpayOrderId: response.razorpay_order_id,
                            razorpayPaymentId: response.razorpay_payment_id,
                            razorpaySignature: response.razorpay_signature
                        })
                    });

                    if (verifyRes.ok) {
                        window.location.href = "success.html";
                    } else {
                        window.location.href = "failure.html";
                    }
                },
                "prefill": {
                    "name": document.getElementById('name').value,
                    "email": document.getElementById('email').value
                },
                "theme": { "color": "#3399cc" }
            };

            const rzp = new Razorpay(options);
            rzp.open();

        } catch (err) {
            console.error(err);
            alert(err.message);
        }
    });
</script>
</body>
</html>
